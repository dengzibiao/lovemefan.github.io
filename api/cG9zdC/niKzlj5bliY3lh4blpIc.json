{"title":"Python小实践   下载漫画","date":"2018-06-12T12:49:00.000Z","thumbnail":"images/fbb.jpg","excerpt":"","slug":"爬取前准备","tags":["学习笔记","Python","编程语言"],"updated":"2018-09-04T03:15:21.366Z","content":"<h1 id=\"爬取前准备\"><a href=\"#爬取前准备\" class=\"headerlink\" title=\"爬取前准备\"></a>爬取前准备</h1><p><a href=\"https://github.com/lovemefan/python_tools\" target=\"_blank\" rel=\"external\">GitHub项目</a><br>目标网站:<a href=\"http://www.omanhua.com/comic/17521/\" target=\"_blank\" rel=\"external\">http://www.omanhua.com/comic/17521/</a><br><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180612/jm0j3bkaiB.png?imageslim\" alt=\"mark\"></p>\n<h2 id=\"分析网页\"><a href=\"#分析网页\" class=\"headerlink\" title=\"分析网页\"></a>分析网页</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">\"subBookList\"</span>&gt;</span></div><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">ul</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">'/comic/17521/366691/'</span> <span class=\"attr\">title</span>=<span class=\"string\">'332'</span> <span class=\"attr\">target</span>=<span class=\"string\">'_blank'</span> <span class=\"attr\">class</span>=<span class=\"string\">'new'</span>&gt;</span>332<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">'/comic/17521/364901/'</span> <span class=\"attr\">title</span>=<span class=\"string\">'331'</span> <span class=\"attr\">target</span>=<span class=\"string\">'_blank'</span> <span class=\"attr\">class</span>=<span class=\"string\">'new'</span>&gt;</span>331<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">'/comic/17521/364900/'</span> <span class=\"attr\">title</span>=<span class=\"string\">'腾讯动漫6周年福利活动！'</span> <span class=\"attr\">target</span>=<span class=\"string\">'_blank'</span> <span class=\"attr\">class</span>=<span class=\"string\">'new'</span>&gt;</span>腾讯动漫6周年福利活动！<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">'/comic/17521/364899/'</span> <span class=\"attr\">title</span>=<span class=\"string\">'330。他们也是我们'</span> <span class=\"attr\">target</span>=<span class=\"string\">'_blank'</span> <span class=\"attr\">class</span>=<span class=\"string\">'new'</span>&gt;</span>330。他们也是我们<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">href</span>=<span class=\"string\">'/comic/17521/364730/'</span> <span class=\"attr\">title</span>=<span class=\"string\">'329'</span> <span class=\"attr\">target</span>=<span class=\"string\">'_blank'</span> <span class=\"attr\">class</span>=<span class=\"string\">'new'</span>&gt;</span>329<span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></div><div class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">li</span>&gt;</span></div><div class=\"line\">\t...</div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">ul</span>&gt;</span></div></pre></td></tr></table></figure>\n<p>这里很明显 每个&amp;lta&amp;gt标签的href属性的值就是具体每一话的url<br>先点进一话的页面看看<br><a href=\"http://www.omanhua.com/comic/17521/366691/\" target=\"_blank\" rel=\"external\">http://www.omanhua.com/comic/17521/366691/</a></p>\n<h2 id=\"抓包分析\"><a href=\"#抓包分析\" class=\"headerlink\" title=\"抓包分析\"></a>抓包分析</h2><p><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180612/aJDLmKLIc8.png?imageslim\" alt=\"mark\"><br>哈哈,没错这个,这是当前显示的一张漫画.但是只有一张.再看看下一张<br><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180612/iij3m7cKh7.png?imageslim\" alt=\"mark\"><br>对比URL路径,我特么..,没有丝毫规律,陷入了僵局…,于是没有了后文.</p>\n<p>我就像看个漫画嘛,要不是腾讯收费,我&amp;<em>%^</em>&amp;%.<br>但我还没有放弃,我打算看看js代码里有没有请求什么的痕迹<br>就在我垂头顿足的时候,我发现了再网页里的一段神奇的代码<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"xml\">  var pVars = pVars || &#123;&#125;; var uzmh = uzmh || &#123;&#125;;eval(function(p,a,c,k,e,d)</span></div><div class=\"line\">&#123;</div><div class=\"line\">\te=function(c)&#123;return(c</div><div class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">a?\"\":e(parseInt(c</span>/<span class=\"attr\">a</span>)))+((<span class=\"attr\">c</span>=<span class=\"string\">c%a)</span>&gt;</span>35?String.fromCharCode(c+29):c.toString(36))&#125;;</div><div class=\"line\">\tif(!''.replace(/^/,String))&#123;while(c--)d[e(c)]=k[c]||e(c);k=[function(e)&#123;return d[e]&#125;];</div><div class=\"line\">\t\te=function()&#123;return'\\\\w+'&#125;;c=1;&#125;;</div><div class=\"line\">\twhile(c--)</div><div class=\"line\">\t\tif(k[c])p=p.replace(new RegExp('\\\\b'+e(c)+'\\\\b','g'),k[c]);</div><div class=\"line\">\treturn p;</div><div class=\"line\">&#125;('h i=&#123;\"g\":1,\"e\":\"4\",\"f\":\"1.0\",\"m\":\"/n/1/2/l.j\",\"k\":2,\"6\":\"3\",\"7\":[\"8.0\",\"c.0\",\"5.0\",\"b.0\",\"9.0\",\"a.0\",\"d.0\",\"o.0\",\"D.0\",\"E.0\",\"C.0\",\"A.0\",\"B.0\",\"I.0\",\"J.0\",\"H.0\",\"F.0\",\"G.0\",\"z.0\",\"s.0\",\"t.0\",\"r.0\"],\"p\":q,\"x\":y,\"w\":\"/u/v/4/3/\"&#125;||&#123;&#125;;</div><div class=\"line\">',46,46,'jpg|17521|366691|332|一人之下|388594b38e|cname|files|38ba1443ba|38f89724c3|381bce4fb2|3886aef5b2|38b823d13d|3857d21ce5|bname|bpic|bid|var|cInfo|html|cid|index|burl|comic|38779d6852|finished|false|3971856aff|399a8af80e|39cc4b3915|tu|undefined|path|len|22|39f92a9dae|387ed1275c|38e5f2512a|385573db27|387ab75347|3866af1df0|38d7d1fc53|382c0123f1|386a165c3e|3859ad824b|38e85b3b5a'.split('|'),0,&#123;&#125;))</div><div class=\"line\"></div><div class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></div></pre></td></tr></table></figure></p>\n<h2 id=\"小有成就\"><a href=\"#小有成就\" class=\"headerlink\" title=\"小有成就\"></a>小有成就</h2><p><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180612/G5L5cHjgFf.png?imageslim\" alt=\"mark\"><br>通过一比对<br>哇!!!我抑制不住内心的激动,这不就是图片名吗?<br>以上代码为例,包含了漫画编号(17521),漫画集数编号(36691),漫画集数(332),漫画名(一人之下),当前集的漫画图片数(len=22),以及每张图片的文件名(比如38ba1443ba.jpg)<br>大功告成!!!</p>\n<h1 id=\"爬取图片\"><a href=\"#爬取图片\" class=\"headerlink\" title=\"爬取图片\"></a>爬取图片</h1><h2 id=\"思路\"><a href=\"#思路\" class=\"headerlink\" title=\"思路\"></a>思路</h2><p>有之前准备已经可以再页面上得到每一话的URL,每一话中的图片URL,剩下的就是对页面里的数据提取,分别下载了</p>\n<h2 id=\"python-代码\"><a href=\"#python-代码\" class=\"headerlink\" title=\"python 代码\"></a>python 代码</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># -*- codeing: utf-8 -*-</span></div><div class=\"line\"><span class=\"comment\"># @Time:2018/3/13 22:20</span></div><div class=\"line\"><span class=\"comment\"># @Author:lovemefan</span></div><div class=\"line\"><span class=\"comment\"># @File:一人之下漫画爬虫.py</span></div><div class=\"line\"><span class=\"comment\"># @Software:PyCharm</span></div><div class=\"line\"><span class=\"keyword\">import</span> os</div><div class=\"line\"><span class=\"keyword\">from</span> imp <span class=\"keyword\">import</span> reload</div><div class=\"line\"><span class=\"keyword\">import</span> re</div><div class=\"line\"><span class=\"keyword\">import</span> requests <span class=\"keyword\">as</span> requests</div><div class=\"line\"><span class=\"keyword\">from</span> urllib.request <span class=\"keyword\">import</span> urlretrieve</div><div class=\"line\"></div><div class=\"line\">requestSession = requests.session()</div><div class=\"line\"><span class=\"comment\"># 保存一张图片</span></div><div class=\"line\"><span class=\"comment\"># 输入参数imgUrl 图片路径,imgPath 保存路径</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">savePicture</span><span class=\"params\">(imgUrl, imgPath)</span>:</span></div><div class=\"line\">    response = requests.get(imgUrl)</div><div class=\"line\">    codimg = response.content</div><div class=\"line\">    fn = open(imgPath, <span class=\"string\">'wb'</span>)</div><div class=\"line\">    fn.write(codimg)</div><div class=\"line\">    fn.close()</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># 一人之下的漫画路径</span></div><div class=\"line\">url = <span class=\"string\">\"http://www.omanhua.com/comic/17521/\"</span></div><div class=\"line\">html = requests.get(url)</div><div class=\"line\">html.encoding = <span class=\"string\">'UTF-8'</span></div><div class=\"line\"><span class=\"comment\"># print(html.text)</span></div><div class=\"line\"><span class=\"comment\"># 先获取每一话</span></div><div class=\"line\"><span class=\"comment\"># 先将数据块取出</span></div><div class=\"line\">bookListBlock = re.findall(<span class=\"string\">r'&lt;div class=\"subBookList\"&gt;(.*?)&lt;/div&gt;&lt;/div&gt;'</span>, html.text, re.S)</div><div class=\"line\"><span class=\"comment\"># booklist 为每一话的URL的列表</span></div><div class=\"line\">bookList = re.findall(<span class=\"string\">\"&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href='(.*?)' title='(.*?)'\"</span>, bookListBlock[<span class=\"number\">0</span>],re.S)</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\"># 逐话操作</span></div><div class=\"line\"><span class=\"keyword\">for</span> index <span class=\"keyword\">in</span> bookList:</div><div class=\"line\">    indexUrl = <span class=\"string\">\"http://www.omanhua.com/\"</span>+index[<span class=\"number\">0</span>]+<span class=\"string\">'index.html'</span></div><div class=\"line\">    indexHtml = requests.get(indexUrl)</div><div class=\"line\">    indexHtml.encoding = <span class=\"string\">'UTF-8'</span></div><div class=\"line\">    print(indexHtml.url)</div><div class=\"line\">    <span class=\"comment\"># 获得当前话的每张图片路径</span></div><div class=\"line\">    picList = re.findall(<span class=\"string\">\"一人之下\\|(.*?)'\\.\"</span>, indexHtml.text)[<span class=\"number\">0</span>].split(<span class=\"string\">'|'</span>)</div><div class=\"line\">    <span class=\"comment\">#删去piclist无用的信息</span></div><div class=\"line\">    <span class=\"keyword\">for</span> item <span class=\"keyword\">in</span> picList[:]:</div><div class=\"line\">        <span class=\"keyword\">if</span> item.__len__() != <span class=\"number\">10</span>:</div><div class=\"line\">            picList.remove(item)</div><div class=\"line\"></div><div class=\"line\">    print(index[<span class=\"number\">1</span>]+<span class=\"string\">'共有%d页'</span>%picList.__len__())</div><div class=\"line\">    picUrlRoot = <span class=\"string\">u'http://pic.fxdm.cc/tu/undefined/一人之下/'</span></div><div class=\"line\">    <span class=\"comment\"># 指定存储位置</span></div><div class=\"line\">    location = <span class=\"string\">\"J:/一人之下\"</span></div><div class=\"line\">    <span class=\"comment\"># 分开放图片</span></div><div class=\"line\">    <span class=\"comment\"># for page in range(len(picList)):</span></div><div class=\"line\">    <span class=\"comment\">#     if not os.path.exists(\"%s/%s/\"%(location,index[1])):</span></div><div class=\"line\">    <span class=\"comment\">#         os.makedirs(\"%s/%s/\"%(location,index[1]))</span></div><div class=\"line\">    <span class=\"comment\">#     picUrl = picUrlRoot+ index[1]+'/'+picList[page]+'.jpg'</span></div><div class=\"line\">    <span class=\"comment\">#     path = \"%s/%s/%d.jpg\"%(location,index[1],page)</span></div><div class=\"line\">    <span class=\"comment\">#     picUrl.encode('UTF-8')</span></div><div class=\"line\">    <span class=\"comment\">#     #不下载已经下载过的图片,便于更新</span></div><div class=\"line\">    <span class=\"comment\">#     if not os.path.exists(path):</span></div><div class=\"line\">    <span class=\"comment\">#         savePicture(picUrl,path)</span></div><div class=\"line\">    <span class=\"comment\">#         print(picUrl + ' 保存到了 ' + path)</span></div><div class=\"line\">    <span class=\"comment\">#</span></div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\"># 一起放图片</span></div><div class=\"line\">    <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> os.path.exists(location):</div><div class=\"line\">        os.makedirs(location)</div><div class=\"line\">    <span class=\"keyword\">for</span> page <span class=\"keyword\">in</span> range(len(picList)):</div><div class=\"line\">        picUrl = picUrlRoot+ index[<span class=\"number\">1</span>]+<span class=\"string\">'/'</span>+picList[page]+<span class=\"string\">'.jpg'</span></div><div class=\"line\">        path = <span class=\"string\">\"%s/%s_%d.jpg\"</span>%(location,index[<span class=\"number\">1</span>],page)</div><div class=\"line\">        picUrl.encode(<span class=\"string\">'UTF-8'</span>)</div><div class=\"line\">        <span class=\"comment\"># 不下载已经下载过的图片,便于更新</span></div><div class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> os.path.exists(path):</div><div class=\"line\">            savePicture(picUrl,path)</div><div class=\"line\">            print(picUrl + <span class=\"string\">' 保存到了 '</span> + path)</div></pre></td></tr></table></figure>\n<p>如果想要图片分开放,取消掉注释的代码,注释掉后面一段代码</p>\n<h2 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h2><p><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180612/idJgkeGKgi.png?imageslim\" alt=\"mark\"></p>\n<h3 id=\"分开放\"><a href=\"#分开放\" class=\"headerlink\" title=\"分开放\"></a>分开放</h3><p><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180612/8iDf2611JC.png?imageslim\" alt=\"mark\"></p>\n<h3 id=\"一起放\"><a href=\"#一起放\" class=\"headerlink\" title=\"一起放\"></a>一起放</h3><p><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180612/J4gh2Gb514.png?imageslim\" alt=\"mark\"></p>\n<p>我要去看漫画了,不要打扰我(/≧▽≦)/~┴┴ </p>\n<h2 id=\"源码在这\"><a href=\"#源码在这\" class=\"headerlink\" title=\"源码在这\"></a><a href=\"https://github.com/lovemefan/python_tools/blob/master/%E6%BC%AB%E7%94%BB/%E4%B8%80%E4%BA%BA%E4%B9%8B%E4%B8%8B%E6%BC%AB%E7%94%BB%E7%88%AC%E8%99%AB.py\" target=\"_blank\" rel=\"external\"><code>源码在这</code></a></h2>","next":{"title":"Python小实践   微博爬虫","slug":"抓取女神微博动态并保存到数据库"},"link":"/2018/06/12","toc":[{"title":"爬取前准备","id":"爬取前准备","index":"1","children":[{"title":"分析网页","id":"分析网页","index":"1.1"},{"title":"抓包分析","id":"抓包分析","index":"1.2"},{"title":"小有成就","id":"小有成就","index":"1.3"}]},{"title":"爬取图片","id":"爬取图片","index":"2","children":[{"title":"思路","id":"思路","index":"2.1"},{"title":"python 代码","id":"python-代码","index":"2.2"},{"title":"结果","id":"结果","index":"2.3","children":[{"title":"分开放","id":"分开放","index":"2.3.1"},{"title":"一起放","id":"一起放","index":"2.3.2"}]},{"title":"","id":"源码在这","index":"2.4"}]}]}