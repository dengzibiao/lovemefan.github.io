{"title":"Python小实践   微博爬虫","date":"2018-05-28T10:25:00.000Z","excerpt":"","slug":"抓取女神微博动态并保存到数据库","comments":true,"tags":["学习笔记","Python","编程语言"],"updated":"2018-09-04T02:39:21.263Z","content":"<h1 id=\"抓取女神微博动态并保存到数据库\"><a href=\"#抓取女神微博动态并保存到数据库\" class=\"headerlink\" title=\"抓取女神微博动态并保存到数据库\"></a>抓取女神微博动态并保存到数据库</h1><p>偶少有刷微博,常常错过女神的动态.微博客户端也常常不给我推送动态,于是我想自己给自己推送,而且还想把数据保存到自己的数据库里,于是有了接下来的尝试</p>\n<h2 id=\"使用chrome浏览器抓包\"><a href=\"#使用chrome浏览器抓包\" class=\"headerlink\" title=\"使用chrome浏览器抓包\"></a>使用chrome浏览器抓包</h2><p>这里随便用什么软件都可以,目的只是抓包.本人使用chrome抓包<br>按下F12,查看这两个getindex的数据包<br>需要获得两个参数<code>uid</code>和<code>containerid</code><br><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180528/7HhB9BliF2.png?imageslim\" alt=\"mark\"><br>这里需要通过手机版weibo <a href=\"http://m.weibo.com来进行模拟请求，不是通过分析html代码再通过筛选来完成数据抓取。\" target=\"_blank\" rel=\"external\">http://m.weibo.com来进行模拟请求，不是通过分析html代码再通过筛选来完成数据抓取。</a><br>笔者先用postmen软件模拟一次post请求,返回结果如下<br><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180528/8c54K4H2E1.png?imageslim\" alt=\"mark\"><br>返回的是json数据,接下来就是处理数据了</p>\n<h2 id=\"模拟请求\"><a href=\"#模拟请求\" class=\"headerlink\" title=\"模拟请求\"></a>模拟请求</h2><p>以下是python模拟的post请求<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">import</span> requests</div><div class=\"line\"><span class=\"keyword\">import</span> json</div><div class=\"line\"><span class=\"keyword\">import</span> pymysql</div><div class=\"line\">cursor = db.cursor()</div><div class=\"line\">url=<span class=\"string\">\"https://m.weibo.cn/api/container/getIndex\"</span></div><div class=\"line\"><span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> range(<span class=\"number\">10</span>):</div><div class=\"line\">    <span class=\"comment\"># 用户的uid,containerid,以及页数.每页最多为十条记录</span></div><div class=\"line\">    payload=&#123;<span class=\"string\">'type'</span>:<span class=\"string\">'uid'</span>,<span class=\"string\">'value'</span>:<span class=\"string\">'56xxxxxx00'</span>,<span class=\"string\">'containerid'</span>:<span class=\"string\">'1076xxxxxxxx5400'</span>,<span class=\"string\">'page'</span>: <span class=\"string\">'%d'</span>%page&#125;</div><div class=\"line\">    r=requests.post(url,data=payload)</div><div class=\"line\">    raw_text=r.text</div><div class=\"line\">    d=json.loads(raw_text)</div><div class=\"line\">``` </div><div class=\"line\">由于每页只有最新的十条记录,所以需要把每一页的数据都存起来</div><div class=\"line\"></div><div class=\"line\"><span class=\"comment\">## 数据库建表</span></div><div class=\"line\">笔者选择了一些基本信息存储,并没有保存评论信息.其中包括</div><div class=\"line\">* itemid 每条微博的ID</div><div class=\"line\">* scheme 每条微博的跳转链接(方便查看)</div><div class=\"line\">* id 也是用于表示每条微博的ID,具体与itemid的区别笔者未深究</div><div class=\"line\">* created_at 发微博的时间,精确到天</div><div class=\"line\">* text 微博内容</div><div class=\"line\">* source 微博来源,比如手机型号</div><div class=\"line\">* user_id 发微博的用户ID </div><div class=\"line\">``` sql</div><div class=\"line\">SET FOREIGN_KEY_CHECKS=<span class=\"number\">0</span>;</div><div class=\"line\"></div><div class=\"line\">-- ----------------------------</div><div class=\"line\">-- Table structure <span class=\"keyword\">for</span> mblog</div><div class=\"line\">-- ----------------------------</div><div class=\"line\">DROP TABLE IF EXISTS `mblog`;</div><div class=\"line\">CREATE TABLE `mblog` (</div><div class=\"line\">  `itemid` varchar(<span class=\"number\">40</span>) NOT NULL,</div><div class=\"line\">  `scheme` varchar(<span class=\"number\">100</span>) DEFAULT NULL,</div><div class=\"line\">  `id` varchar(<span class=\"number\">20</span>) DEFAULT NULL,</div><div class=\"line\">  `created_at` varchar(<span class=\"number\">10</span>) DEFAULT NULL,</div><div class=\"line\">  `text` text,</div><div class=\"line\">  `source` varchar(<span class=\"number\">20</span>) DEFAULT NULL,</div><div class=\"line\">  `user_id` varchar(<span class=\"number\">20</span>) DEFAULT NULL,</div><div class=\"line\">  PRIMARY KEY (`itemid`)</div><div class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</div></pre></td></tr></table></figure></p>\n<h2 id=\"分析数据并插入表中\"><a href=\"#分析数据并插入表中\" class=\"headerlink\" title=\"分析数据并插入表中\"></a>分析数据并插入表中</h2><p>这里直接贴代码了,代码有详细注释<br><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"comment\"># -*- codeing: utf-8 -*-</span></div><div class=\"line\"><span class=\"comment\"># @Time:2018/5/28 14:31</span></div><div class=\"line\"><span class=\"comment\"># @Author:lovemefan</span></div><div class=\"line\"><span class=\"comment\"># @File:抓取女神微博动态保存到数据库.py</span></div><div class=\"line\"><span class=\"comment\"># @Software:PyCharm</span></div><div class=\"line\"><span class=\"comment\">#</span></div><div class=\"line\"><span class=\"comment\">#原始URL:https://m.weibo.cn/p/100xxxxxxxx15400</span></div><div class=\"line\"><span class=\"keyword\">import</span> requests</div><div class=\"line\"><span class=\"keyword\">import</span> json</div><div class=\"line\"><span class=\"keyword\">import</span> pymysql</div><div class=\"line\"><span class=\"comment\"># 打开数据库连接</span></div><div class=\"line\">db = pymysql.connect(<span class=\"string\">\"localhost\"</span>, <span class=\"string\">\"账号\"</span>, <span class=\"string\">\"密码\"</span>, <span class=\"string\">\"数据库名\"</span>, charset=<span class=\"string\">'utf8'</span>)</div><div class=\"line\"><span class=\"comment\"># 使用cursor()方法获取操作游标</span></div><div class=\"line\">cursor = db.cursor()</div><div class=\"line\">url=<span class=\"string\">\"https://m.weibo.cn/api/container/getIndex\"</span></div><div class=\"line\">page = <span class=\"number\">1</span></div><div class=\"line\">sum = <span class=\"number\">0</span></div><div class=\"line\"><span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> range(<span class=\"number\">35</span>):</div><div class=\"line\">    <span class=\"comment\"># 用户的uid,containerid,以及页数.每页最多为十条记录</span></div><div class=\"line\">    payload=&#123;<span class=\"string\">'type'</span>:<span class=\"string\">'uid'</span>,<span class=\"string\">'value'</span>:<span class=\"string\">'56xxxxxx00'</span>,<span class=\"string\">'containerid'</span>:<span class=\"string\">'10760xxxxxxxx400'</span>,<span class=\"string\">'page'</span>: <span class=\"string\">'%d'</span>%page&#125;</div><div class=\"line\">    r=requests.post(url,data=payload)</div><div class=\"line\">    raw_text=r.text</div><div class=\"line\">    d=json.loads(raw_text)</div><div class=\"line\">    <span class=\"keyword\">try</span>:</div><div class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">10</span>):</div><div class=\"line\">            print(<span class=\"string\">\"第%d页第%d条\"</span>% (page,i))</div><div class=\"line\">            print(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>])</div><div class=\"line\">            itemid = str(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>][i][<span class=\"string\">\"itemid\"</span>])</div><div class=\"line\">            scheme = str(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>][i][<span class=\"string\">\"scheme\"</span>])</div><div class=\"line\">            id = str(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>][i][<span class=\"string\">\"mblog\"</span>][<span class=\"string\">\"id\"</span>])</div><div class=\"line\">            create_at = str(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>][i][<span class=\"string\">\"mblog\"</span>][<span class=\"string\">\"created_at\"</span>])</div><div class=\"line\">            <span class=\"comment\">#将内容中的单引号换成双引号,否则插入数据库中会报错</span></div><div class=\"line\">            text = str(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>][i][<span class=\"string\">\"mblog\"</span>][<span class=\"string\">\"text\"</span>]).replace(<span class=\"string\">\"'\"</span>,<span class=\"string\">\"\\\"\"</span>)</div><div class=\"line\">            source = str(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>][i][<span class=\"string\">\"mblog\"</span>][<span class=\"string\">\"source\"</span>])</div><div class=\"line\">            user_id = str(d[<span class=\"string\">\"data\"</span>][<span class=\"string\">\"cards\"</span>][i][<span class=\"string\">\"mblog\"</span>][<span class=\"string\">\"user\"</span>][<span class=\"string\">\"id\"</span>])</div><div class=\"line\">            <span class=\"comment\"># sql插入语句</span></div><div class=\"line\">            sql = <span class=\"string\">\"insert ignore into mblog(itemid,scheme,id,created_at,text,source,user_id) VALUES('%s','%s','%s','%s','%s','%s','%s')\"</span> % (itemid,scheme,id,create_at,text,source,user_id)</div><div class=\"line\">            print(sql)</div><div class=\"line\">            <span class=\"comment\"># 执行sql语句</span></div><div class=\"line\">            cursor.execute(sql)</div><div class=\"line\">            <span class=\"comment\"># 执行sql语句</span></div><div class=\"line\">            db.commit()</div><div class=\"line\">            sum = sum + <span class=\"number\">1</span></div><div class=\"line\">    <span class=\"keyword\">except</span> IndexError:</div><div class=\"line\">        <span class=\"comment\"># 但记录不满10条的时候,捕获list越界异常,自动跳过</span></div><div class=\"line\">        <span class=\"keyword\">pass</span></div><div class=\"line\"></div><div class=\"line\">    page = page + <span class=\"number\">1</span></div><div class=\"line\">    print(<span class=\"string\">\"第%d页执行成功\"</span>%page)</div><div class=\"line\">        <span class=\"comment\"># print([\"text\"])</span></div><div class=\"line\">db.close()</div><div class=\"line\">print(<span class=\"string\">\"一共插入了%d的条记录\"</span>% sum)</div></pre></td></tr></table></figure></p>\n<h2 id=\"结果\"><a href=\"#结果\" class=\"headerlink\" title=\"结果\"></a>结果</h2><p><img src=\"http://oskhhyaq3.bkt.clouddn.com/img/180528/ICjHHa2I31.png?imageslim\" alt=\"mark\"><br>保存成功,然后就可以去翻数据库里的数据了.</p>\n<h2 id=\"缺陷\"><a href=\"#缺陷\" class=\"headerlink\" title=\"缺陷\"></a>缺陷</h2><ul>\n<li>只能一次性的保存至今的记录,后续添加监听并邮箱推送</li>\n<li>后续可以添加数据分析,关键子词云</li>\n</ul>\n","prev":{"title":"Python小实践   下载漫画","slug":"爬取前准备"},"next":{"title":"Android学习笔记 (三)   MP3播放器","slug":"MP3播放器"},"link":"/post/抓取女神微博动态并保存到数据库/index.html  2018/05/28","toc":[{"title":"抓取女神微博动态并保存到数据库","id":"抓取女神微博动态并保存到数据库","index":"1","children":[{"title":"使用chrome浏览器抓包","id":"使用chrome浏览器抓包","index":"1.1"},{"title":"模拟请求","id":"模拟请求","index":"1.2"},{"title":"分析数据并插入表中","id":"分析数据并插入表中","index":"1.3"},{"title":"结果","id":"结果","index":"1.4"},{"title":"缺陷","id":"缺陷","index":"1.5"}]}]}